# 算法配置管理测试用例（UAT/API）

## 1. 说明
- 适用范围：`算法配置`、`资源分配`、`镜像管理`
- 测试类型：API + 页面联调 + 业务规则校验
- 前置条件：数据库已执行 `sql/001_algo_config_schema.sql`

## 2. 算法配置模块
| 用例ID | 场景 | 步骤 | 预期结果 |
|---|---|---|---|
| TC-ALGO-001 | 新增成功 | 输入必填字段并提交 | 返回成功，列表新增记录 |
| TC-ALGO-002 | Recipe ID 重复 | 新增已存在 `recipe_id` | 返回错误码 `A001` |
| TC-ALGO-003 | 算法配置 JSON 非法 | `algorithm_config_json` 输入非法 JSON | 返回错误码 `A002` |
| TC-ALGO-004 | 开启聚合但 DC 配置为空 | `aggregate_enabled=true` 且 `dc_config_json` 空 | 返回错误码 `A003` |
| TC-ALGO-005 | 编辑成功 | 修改算法版本并保存 | 返回成功，更新时间变化 |
| TC-ALGO-006 | 启停切换 | 调用 status 接口切换 enabled | 状态与列表显示一致 |
| TC-ALGO-007 | 删除成功 | 删除未被依赖记录 | 记录删除，日志新增 |
| TC-ALGO-008 | 文件上传 | 上传 `.py` 文件 | 返回文件路径并写入数据库 |
| TC-ALGO-009 | 关键字搜索 | 输入算法名/Recipe ID/Product ID 查询 | 返回匹配记录 |
| TC-ALGO-010 | 未授权访问 | 无 token 调用新增接口 | 返回 401/403 |
| TC-ALGO-011 | 展开态详情展示 | 展开列表记录，读取详情接口 | 返回并展示算法描述、算法文件、算法配置、配置开关、创建/更新时间 |

## 3. 资源分配模块
| 用例ID | 场景 | 步骤 | 预期结果 |
|---|---|---|---|
| TC-RES-001 | 新增资源配置成功 | 选择算法、镜像并设置资源 | 返回成功，列表新增 |
| TC-RES-002 | CPU 请求超过限制 | `cpu_request > cpu_limit` | 返回错误码 `R001` |
| TC-RES-003 | 内存请求超过限制 | `mem_request > mem_limit` | 返回错误码 `R001` |
| TC-RES-004 | 资源格式非法 | CPU/内存填非法格式 | 返回错误码 `C001` |
| TC-RES-005 | 编辑资源配置成功 | 修改 CPU 限制并提交 | 返回成功，数据更新 |
| TC-RES-006 | 部署触发成功 | 调用 deploy 接口 | 返回成功并记录日志 |
| TC-RES-007 | 定时触发成功 | 调用 schedule 接口 | 返回成功并记录计划信息 |
| TC-RES-008 | 回滚成功 | 调用 rollback 接口 | current_version 回退 |
| TC-RES-009 | 删除资源配置成功 | 删除目标记录 | 删除成功并记录日志 |
| TC-RES-010 | 列表排序校验 | 查询列表 | 按 `updated_at` 倒序 |

## 4. 镜像管理模块
| 用例ID | 场景 | 步骤 | 预期结果 |
|---|---|---|---|
| TC-IMG-001 | 新增镜像成功 | 输入 name/tag/registry 并提交 | 返回成功，列表新增 |
| TC-IMG-002 | 镜像重复 | 新增相同 `image_name+image_tag` | 返回错误码 `I001` |
| TC-IMG-003 | 编辑镜像成功 | 修改描述与关联算法 | 返回成功并刷新列表 |
| TC-IMG-004 | 镜像状态切换 | 调用 status 接口禁用/启用 | 状态生效 |
| TC-IMG-005 | 禁用镜像引用校验 | 使用禁用镜像新增资源配置 | 返回失败 |
| TC-IMG-006 | 删除被依赖镜像 | 该镜像被资源配置引用时删除 | 返回错误码 `I002` |
| TC-IMG-007 | 删除未依赖镜像 | 删除无依赖镜像 | 删除成功 |
| TC-IMG-008 | 部署接口 | 调用 deploy 接口 | 返回成功并记录日志 |
| TC-IMG-009 | 关联算法展示 | 一个镜像关联多个算法 | 列表展示多标签 |
| TC-IMG-010 | 仓库地址必填校验 | 空 registry_url 提交 | 返回参数错误 |

## 5. 操作日志与审计
| 用例ID | 场景 | 步骤 | 预期结果 |
|---|---|---|---|
| TC-LOG-001 | 新增日志 | 新增算法配置 | `operation_log` 写入 CREATE |
| TC-LOG-002 | 编辑日志 | 编辑镜像配置 | 写入 UPDATE，content 含变更字段 |
| TC-LOG-003 | 删除日志 | 删除资源配置 | 写入 DELETE |
| TC-LOG-004 | 启停日志 | 切换算法/镜像状态 | 写入 ENABLE 或 DISABLE |

## 6. 回归基线
- 三模块核心 CRUD 全通过
- 所有错误码按预期返回
- 所有关键操作均有日志
- 接口文档与实际行为一致
